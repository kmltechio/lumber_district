# lumber_district

Configuration and automation settings for an N scale layout modeled off of CB&Q's Lumber District in Chicago's Pilsen neighborhood during the 1950s/60s.

Trains on the main section of the layout are powered by DCC signals generated by [CommandStation-EX](https://dcc-ex.com/ex-commandstation/index.html) running on an [Arduino Mega 2560 Rev3](https://store-usa.arduino.cc/products/arduino-mega-2560-rev3) with an [Arduino Motor Shield](https://store-usa.arduino.cc/collections/shields/products/arduino-motor-shield-rev3) and a [Makerfabs ESP8266 WiFi shield](https://www.makerfabs.com/esp8266-wifi-shield.html). 

A secondary track can toggle between DCC Programming mode and DC power to run legacy DC locomotives. This will most often run a street trolley with automation scripted by EX-RAIL. 

Mimic panels are designed around Berret Hill Touch Toggles driven by custom code loaded onto an Arduino Nano Every which communicates with the Mega over I2C

Also on the I2C bus are two 16pin GPIO expanders to activate L289N H Bridges which drive the Kato Unitrack snap turnouts.

Finally an Arduino Nano Every with custom code drives static and animated LED lighting across the layout. 

## Prerequisites

1. Unix-like system with GNU make (developed and tested on MacOS)
1. [1Password CLI](https://developer.1password.com/docs/cli/get-started#install) - so that I don't have to commit my home wifi network password
1. [Arduino IDE](https://www.arduino.cc/en/software) - v1.8.x is preferred over 2.0.x as it generates more compact compiled objects.

TODO investigate use of [arduino-cli](https://github.com/arduino/arduino-cli) instead of IDE

## Setup

`make` will do the following:
1. git clone the CommandStation-EX repo
1. switch it to the specified branch
1. copy the local header comfig/marco files into the CommandStation-EX folder

## TODOs

1. Will eventually have code for the I2C arduinos that manage the touch toggles

## Diagrams

### Power Distribution

```mermaid
flowchart LR
  subgraph ac ["⚡️120V A/C⚡️"]
    P120[Wall Plug]
    Pswitch[On/Off]
    PSU
    end
  P120 -->|black| Pswitch --> PSU
  P120 -->|white| PSU
  P120 -->|green| PSU
  Buck14[Buck 14V]
  Buck8[Buck 8V]
  PSU -->|24V| Buck14 & Buck8
  subgraph CmdStn[CommandStation EX]
    direction BT
    Mega
    Motor[Motor Shield]
    WiFi[Wifi Shield]
    Mega -->|5V| Motor -->|5V| WiFi
    end
  Lights[Lighting Nano]
  Touch[Touch Panel Nano]
  Gpio["GPIO Expanders 1-2"]
  HBridge["H Bridges 1-9"]
  Buck8 -->|8V| Mega
  Buck8 ----->|8V| Lights & Touch
  Buck14 ----->|14V| HBridge
  Buck14 --->|14V| Motor
  Mega ---->|5V| Gpio
  Mega -->|5V| Fan
```

### Communication & Ports

```mermaid
flowchart LR
  subgraph Layout
    CmdStn[ComandStation EX]
    Touch[Touch Panel Nano]
    Gpio["GPIO Expanders 1-2"]
    Touch <-->|I2C| CmdStn
    CmdStn -->|I2C| Gpio
    end
  Wall[Wall Plug]
  Wall -->|"⚡IEC Socket⚡️"| Layout
  Phone & Tablet & Laptop -.->|WiFi| Layout
  Laptop <-->|USB type A| Layout
  Layout -->|2.1mm Barrel Connector| Cassette[Staging Cassette]
```

### Power Panel Wiring

```mermaid
flowchart 
  subgraph Panel[Power Panel]
    Toggle1[Power SPST On-Off]
    Toggle2[Lights SPST On-Off]
    LED1[Track Power LED]
    Toggle3["Prog v. DC SPDT (On)-Off-(On)"]
    LED2[Prog LED]
    LED3[DC LED]
    PanelGND
    end
  Wall[Wall Plug] --->|"⚡️120V A/C⚡️"| Toggle1 ---> PSU
  Buck8[Buck 8V] ---> Toggle2 ---> Lights[Lighting Nano]
  Mega --->|Pin 3| LED1
  Mega -->|Pin TBD1| LED2
  Mega -->|Pin TBD2| Toggle3
  Mega -->|Pin TBD3| Toggle3
  Mega -->|Pin TBD4| LED3
  LED1 & LED2 & LED3 & Toggle3 --> PanelGND --> GND
```

### Touch Panels Wiring

```mermaid
flowchart LR
  subgraph tp1[Lower Level Panel]
    touchLP["Touch Toggle 2.1...2.6"]
    end
  subgraph tp2[Upper Level Panel]
    subgraph base[Nano Base]
      Nano
      end
    touchUP["Touch Toggle 1.1...1.9"]
    end
  Buck8 -->|+8V| Nano -->|GND| Buck8
  Mega -->|I2C Clock| Nano
  Mega <-->|I2C Data| Nano
  Nano -->|I2C Interrupt| Mega
  base -->|"brown +5V"| touchLP & touchUP -->|"red GND"| base
  base <-->|"yellow sensor"| touchLP & touchUP

```

